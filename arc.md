# TableRound 项目架构

## 项目概述
TableRound 是一个基于多智能体对话的圆桌会议系统，专注于剪纸文创产品设计，采用两阶段AI架构，支持统一图像描述机制和智能记忆管理。

## 源代码目录结构 (src/)

```
src/
├── __init__.py
├── main.py                    # 主程序入口
├── agents/                    # 智能体模块
│   ├── __init__.py
│   ├── consumer.py           # 消费者智能体
│   ├── craftsman.py          # 手工艺人智能体
│   ├── designer.py           # 设计师智能体
│   └── manufacturer.py       # 制造商智能体
├── api/                      # API接口模块
│   └── __init__.py
├── config/                   # 配置模块
│   ├── __init__.py
│   ├── models.py            # 模型配置
│   ├── prompts/             # 提示词模板目录
│   │   ├── __init__.py
│   │   ├── agent_prompts/   # 智能体提示词
│   │   │   ├── __init__.py
│   │   │   ├── consumer_prompts.py
│   │   │   ├── craftsman_prompts.py
│   │   │   ├── designer_prompts.py
│   │   │   └── manufacturer_prompts.py
│   │   ├── base_prompts.py  # 基础提示词
│   │   ├── function_prompts/ # 功能提示词
│   │   │   ├── __init__.py
│   │   │   ├── image_story_prompts.py
│   │   │   ├── keyword_extraction_prompts.py
│   │   │   ├── role_switch_prompts.py
│   │   │   └── scenario_prompts.py
│   │   ├── README.md        # 提示词说明文档
│   │   ├── template_manager.py # 模板管理器
│   │   └── test_prompts.py  # 提示词测试
│   ├── prompts.py           # 提示词主模块
│   ├── redis_config.py      # Redis配置
│   └── settings.py          # 系统设置
├── core/                    # 核心功能模块
│   ├── __init__.py
│   ├── agent.py            # 智能体基类和实现
│   ├── conversation.py     # 对话管理器 (统一图像描述机制)
│   ├── global_memory.py    # 全局记忆管理
│   ├── god_view.py         # 上帝视角
│   ├── kj_method.py        # KJ法实现
│   ├── memory.py           # 记忆系统基类
│   ├── memory_adapter.py   # 记忆适配器
│   └── redis_memory.py     # Redis记忆实现
├── models/                 # AI模型接口层
│   ├── __init__.py
│   ├── anthropic.py        # Anthropic模型
│   ├── base.py            # 模型基类
│   ├── deepseek.py        # DeepSeek模型
│   ├── doubao.py          # 豆包模型 (图像生成)
│   ├── google.py          # Google模型
│   ├── mock.py            # 模拟模型
│   ├── openai.py          # OpenAI模型
│   └── openrouter.py      # OpenRouter模型 (两阶段AI架构)
├── ui_enhanced/           # UI美化模块 ✨
│   ├── __init__.py        # 模块导出配置
│   ├── enhanced_colors.py # 增强颜色系统 (256色/RGB/渐变)
│   ├── icons.py           # 图标和符号库 (Unicode/ASCII艺术)
│   ├── ui_components.py   # UI组件库 (面板/进度条/菜单)
│   ├── animations.py      # 动画效果库 (加载/打字机/渐变)
│   └── themes.py          # 主题管理系统 (6种预设主题)
└── utils/                 # 工具函数库
    ├── __init__.py
    ├── colors.py          # 基础终端颜色输出
    ├── image.py           # 图像处理工具
    ├── image_compressor.py # 智能图像压缩
    ├── logger.py          # 日志工具
    ├── stream.py          # 流式处理
    └── voting.py          # 投票算法
```

## 项目根目录结构

```
tableround/
├── src/                      # 源代码目录 (详见上方)
├── ui/                       # 用户界面
│   └── cli/                  # 命令行界面
│       └── terminal.py       # 终端界面实现 (已美化)
├── data/                     # 数据目录
│   ├── images/               # 用户上传的图片
│   ├── keywords/             # 提取的关键词
│   └── memories/             # 智能体记忆备份
│       ├── consumer_1/
│       ├── consumer_2/
│       ├── consumer_3/
│       ├── craftsman_1/
│       ├── designer_1/
│       └── manufacturer_1/
├── .env.example              # 环境变量示例
├── .gitignore                # Git忽略配置
├── arc.md                    # 项目架构文档 (本文件)
├── README.md                 # 项目说明
├── requirements.txt          # 依赖列表
└── run.py                    # 启动脚本
```

## 核心技术架构

### 两阶段AI模型架构 🚀

TableRound采用创新的两阶段AI处理架构：

```
第一阶段: 视觉理解
┌─────────────────────────────────────────┐
│ Google Gemini 2.0 Flash                │
│ • 图像内容识别和分析                     │
│ • 详细场景描述                          │
│ • 视觉元素提取                          │
│ • 艺术特征识别                          │
└─────────────────────────────────────────┘
                │
                ▼
           图像描述结果
                │
                ▼
第二阶段: 多智能体对话
┌─────────────────────────────────────────┐
│ DeepSeek R1 / OpenRouter                │
│ • 基于统一图像描述的智能体对话           │
│ • 专业角色扮演 (手工艺人/消费者等)        │
│ • 创意内容生成与讨论                     │
│ • 记忆保持和角色转换                     │
└─────────────────────────────────────────┘
                │
                ▼
           设计方案产出
                │
                ▼
图像生成: 豆包 API (doubao-seedream-3-0-t2i)
┌─────────────────────────────────────────┐
│ • 基于讨论结果生成视觉作品               │
│ • 无水印高质量输出                       │
│ • 自动压缩和存储                         │
└─────────────────────────────────────────┘
```

### 统一图像描述机制 ✨

**问题解决**：避免每个智能体重复调用视觉模型

**解决方案**：
1. **一次描述，全员共享**：只调用一次视觉模型进行图像描述
2. **用户可见**：图像描述完整展示给用户
3. **智能体协作**：所有智能体基于同一描述进行创作

```python
# 统一图像描述流程
async def process_image(self, image_path: str):
    # 1. 统一图像描述
    image_description = await self._describe_image_once(image_path)

    # 2. 展示给用户
    await self.stream_handler.stream_output(f"===== 图像描述 =====\n{image_description}\n\n")

    # 3. 智能体基于描述创作
    for agent in self.agents.values():
        story, keywords = await agent.tell_story_from_description(image_description, image_path)
```

## 核心模块说明

### 1. 智能体系统 (agents/) 🤖
- **craftsman.py**: 手工艺人智能体 (60岁蒙古族剪纸传承人)
- **consumer.py**: 消费者智能体 (关注用户体验和市场需求)
- **manufacturer.py**: 制造商智能体 (35岁文创产品生产商)
- **designer.py**: 设计师智能体 (23岁研究生设计师)

### 2. 核心引擎 (core/) ⚙️
- **conversation.py**: 对话管理器，实现统一图像描述机制
- **agent.py**: 智能体基类，支持图像描述和角色转换
- **global_memory.py**: 全局记忆管理，Redis分布式存储
- **memory_adapter.py**: 记忆适配器，Redis统一存储接口 ⭐
- **redis_memory.py**: Redis记忆模块（已优化）- 支持缓存、批量操作、安全处理

### 3. AI模型层 (models/) 🧠
- **openrouter.py**: 两阶段AI架构实现
  - 视觉模型: `google/gemini-2.0-flash-exp:free`
  - 对话模型: `deepseek/deepseek-r1-0528:free`
- **doubao.py**: 豆包API集成，专用于图像生成
- **base.py**: 统一模型接口，支持视觉和对话能力

### 4. UI美化模块 (ui_enhanced/) 🎨 新增
- **enhanced_colors.py**: 增强颜色系统 (256色/RGB/渐变效果)
- **icons.py**: 图标和符号库 (Unicode图标/ASCII艺术/智能体图标)
- **ui_components.py**: UI组件库 (面板/进度条/菜单/状态指示器)
- **animations.py**: 动画效果库 (加载动画/打字机效果/渐变动画)
- **themes.py**: 主题管理系统 (6种预设主题/动态切换)

### 5. 工具库 (utils/) 🛠️
- **image_compressor.py**: 智能图像压缩 (节省60-80%空间)
- **colors.py**: 基础终端彩色输出，提升用户体验
- **voting.py**: 共识投票算法，用于关键词选择
- **stream.py**: 流式输出处理，实时反馈

## 技术特点

### 异步架构 ⚡
- **全面异步**: Python asyncio + aiohttp
- **并发处理**: 支持6个智能体同时工作
- **非阻塞I/O**: 网络请求和文件操作不阻塞主线程
- **资源效率**: 协程比多线程消耗更少资源

### 智能图像处理 🖼️
- **自适应压缩**: 根据图像特点智能调整压缩参数
- **格式优化**: 支持HEIF、WebP等现代格式
- **API优化**: 针对AI模型调用优化图像大小和质量
- **批量处理**: 支持多图像并行压缩

### Redis统一记忆系统 🧠
- **Redis存储**: 高性能统一存储方案，替代多种存储方式
- **多层记忆**: 个人记忆 + 全局共享记忆
- **上下文感知**: 智能检索相关记忆内容
- **会议清理**: 每次会议开始时自动清理旧数据
- **性能优化**: 支持TTL过期、LRU缓存、批量操作

### 模块化设计 🏗️
- **插件化AI模型**: 支持多种AI提供商
- **可配置角色**: 智能体行为和性格可定制
- **分层架构**: 清晰的职责分离，便于维护
- **接口统一**: 统一的API调用接口

### 多智能体协作 🤝
- **六个智能体**: 按特定顺序对话 (手工艺人→消费者→制造商→消费者→设计师→消费者)
- **角色转换机制**: 保持记忆的同时切换视角
- **智能体自我介绍**: 300字限制，个性化表达
- **全局记忆共享**: 智能体间信息互通

### 对话流程 📋
1. **智能体自我介绍**: 个性化角色展示
2. **主题讨论**: 一轮深度对话
3. **关键词提取**: AI自动提取和投票
4. **角色转换**: 切换视角但保持记忆
5. **剪纸研讨会**: 专业场景讨论
6. **用户输入**: 设计提示词
7. **图像生成**: AI创作视觉内容

### 图像生成 🎨
- **豆包API**: 使用doubao-seedream-3-0-t2i-250415模型
- **智能提示词**: 自动优化生成提示
- **无水印**: watermark参数默认为false
- **自动存储**: 图像下载和本地保存

### 流式输出 📺
- **实时显示**: 智能体对话实时展示
- **彩色高亮**: 关键词和重要信息彩色标记
- **进度提示**: 清晰的阶段和进度指示
- **用户友好**: 直观的界面和交互体验

## 数据流向

```
┌──────────┐          ┌───────────┐          ┌─────────────┐
│ 用户输入  │─────────▶│ CLI界面   │─────────▶│ 对话管理器   │
└──────────┘          └───────────┘          └──────┬──────┘
                                                   │
                                                   ▼
┌──────────────────┐          ┌──────────────────────────┐
│ 智能图像压缩     │◀─────────│ 统一图像描述 (Gemini)    │
└───────┬──────────┘          └──────────────┬───────────┘
        │                                    │
        ▼                                    ▼
┌──────────────────┐          ┌──────────────────────────┐
│ 图像存储         │          │ 智能体协作 (DeepSeek)    │
└──────────────────┘          └──────────────┬───────────┘
                                             │
                                             ▼
┌──────────────────┐          ┌──────────────────────────┐
│ 流式输出展示     │◀─────────│ Redis记忆存储            │
└───────┬──────────┘          └──────────────────────────┘
        │
        ▼
┌──────────────────┐          ┌──────────────────────────┐
│ 用户实时反馈     │─────────▶│ 图像生成 (豆包API)       │
└──────────────────┘          └──────────────────────────┘
```

## 性能指标 📊

### 响应性能
- **图像压缩**: < 1秒，节省60-80%空间，支持API压缩优化
- **图像描述**: < 3秒 (统一描述，避免重复调用)
- **AI响应**: 平均 < 4秒 (多智能体并行)
- **并发处理**: 支持10+智能体同时工作
- **内存使用**: < 400MB (不含AI模型)

### 可靠性
- **API成功率**: > 99.5%
- **错误恢复**: 自动重试3次，指数退避
- **数据一致性**: Redis事务保证
- **系统可用性**: > 99.9%
- **图像处理**: 支持多格式、自动压缩和水印控制

### 扩展性能
- **支持模型**: Google Gemini, DeepSeek R1, 豆包, Anthropic Claude, OpenAI
- **图像格式**: PNG, JPEG, WebP, HEIF
- **并行处理**: 最大10个并行请求
- **记忆系统**: 支持10000+条记忆项目

## 配置管理

### 环境变量
```bash
# AI配置
AI_PROVIDER=openrouter
AI_MODEL=deepseek/deepseek-r1-0528:free
OPENROUTER_API_KEY=your_api_key

# Redis配置
REDIS_HOST=localhost
REDIS_PORT=6379

# 系统配置
MAX_TURNS=1
MAX_KEYWORDS=10
```

### 系统配置
- **settings.py**: 系统参数和默认值
- **prompts/**: AI提示词模板管理
- **models.py**: 模型参数和配置

### 核心依赖
```python
# 异步网络
aiohttp>=3.8.0
aiofiles>=0.8.0

# AI模型客户端
openai>=1.0.0
anthropic>=0.7.0
google-generativeai>=0.3.0

# 图像处理
Pillow>=9.0.0
pillow-heif>=0.10.0

# 数据存储
redis>=4.5.0

# 工具库
python-dotenv>=0.19.0
requests>=2.28.0
```

## 使用流程

### 快速开始
```bash
# 1. 克隆项目
git clone <repository_url>
cd tableround

# 2. 安装依赖
pip install -r requirements.txt

# 3. 配置环境变量
cp .env.example .env
# 编辑 .env 文件，添加API密钥

# 4. 启动程序
python run.py
```

### 操作流程
1. **选择操作模式**：
   - 开始新对话
   - 处理图片
   - 设计剪纸文创产品
2. **输入主题和参数**：按提示输入相关信息
3. **观看智能体对话**：实时查看多智能体交互
4. **查看结果**：生成的图像和设计方案

## 扩展性

### 新增智能体 🤖
```python
# 1. 创建新智能体类
class NewAgent(Agent):
    def __init__(self, name: str, model: BaseModel):
        super().__init__(name, "new_agent", model)
        self.age = 30
        self.background = "专业背景"
        self.experience = "相关经验"

# 2. 在配置中注册
AGENT_TYPES = {
    "new_agent": NewAgent,
    # ... 其他智能体
}
```

### 新增AI模型 🧠
```python
# 1. 继承基类
class NewModel(BaseModel):
    async def generate(self, prompt: str, system_prompt: str = "") -> str:
        # 实现生成逻辑
        pass

    def supports_vision(self) -> bool:
        return True  # 如果支持图像

# 2. 注册模型
MODEL_REGISTRY = {
    "new_provider": NewModel,
    # ... 其他模型
}
```

### 新增功能模块 ⚙️
1. **在相应目录创建模块**：遵循现有目录结构
2. **实现接口**：继承基类或实现协议
3. **更新配置**：添加相关配置项
4. **编写测试**：确保功能正常工作

## 最新更新 🆕

### v2.2 (2025-06-22)
- ✅ **Redis自动清理修复**: 修复了启动对话时Redis清理功能失效的问题
- ✅ **环境变量解析优化**: 支持带注释的环境变量正确解析
- ✅ **Settings类增强**: 新增`_parse_bool_env`方法处理布尔型环境变量
- ✅ **清理日志完善**: 启动对话时显示详细的Redis清理过程和结果
- ✅ **功能验证**: 确保每次会议开始时Redis数据被正确清理

### v2.1 (2025-06-09)
- ✅ **统一图像描述机制**: 避免重复调用视觉模型
- ✅ **两阶段AI架构**: 视觉理解 + 对话生成
- ✅ **Google Gemini集成**: 强大的视觉理解能力
- ✅ **用户体验优化**: 图像描述对用户可见
- ✅ **性能优化**: 减少API调用，提升响应速度

### 技术债务清理
- 🔧 修复了图像路径传递问题
- 🔧 优化了视觉模型提示词 (英文)
- 🔧 改进了错误处理和日志记录
- 🔧 统一了代码风格和类型注解
- 🔧 修复了Redis自动清理功能的环境变量解析问题

## 项目历程记录

### 开发时间线 📅

#### 第一阶段：基础架构 (2025年5月21日-6月3日)
- 🏗️ **多智能体系统**: 构建6个专业角色智能体
- 🧠 **记忆系统**: 实现Redis分布式记忆管理
- 🔄 **角色转换**: 开发保持记忆的角色切换机制
- 📝 **提示词系统**: 建立模块化提示词管理

#### 第二阶段：前端开发 (2025年6月3日)
- 🖥️ **Web界面**: 开发React前端界面
- ⚙️ **API配置**: 实现多AI提供商配置系统
- 🔧 **集成测试**: 前后端联调和功能验证

#### 第三阶段：优化重构 (2025年6月3日-6月8日)
- 🐛 **Bug修复**: 解决代码分析发现的问题
- 🧹 **代码清理**: 消除重复代码和优化结构
- 📊 **性能优化**: 提升系统响应速度

#### 第四阶段：架构升级 (2025年6月8日-6月9日)
- 🚀 **两阶段AI**: 实现视觉理解+对话生成架构
- 🖼️ **图像优化**: 统一图像描述机制
- 📈 **性能提升**: 减少API调用，优化用户体验

#### 第五阶段：功能修复 (2025年6月22日)
- 🔧 **Redis清理修复**: 解决启动对话时Redis自动清理功能失效问题
- 🛠️ **环境变量优化**: 修复带注释的环境变量解析错误
- 📊 **日志完善**: 增强Redis清理过程的日志输出和用户反馈
- ✅ **功能验证**: 确保会议记忆管理功能正常工作

### 核心技术成就 🏆

#### AI模型集成
- ✅ **6种AI提供商**: OpenRouter, Google, DeepSeek, 豆包等
- ✅ **两阶段架构**: 视觉模型 + 对话模型的创新组合
- ✅ **统一接口**: 抽象化不同AI提供商的差异
- ✅ **流式输出**: 实时响应和用户体验优化

#### 智能体系统
- ✅ **专业角色**: 手工艺人、消费者、制造商、设计师
- ✅ **个性化**: 每个智能体有独特的年龄、背景、经验
- ✅ **记忆保持**: 角色转换时保持对话历史
- ✅ **协作机制**: 智能体间信息共享和协作

#### 图像处理
- ✅ **智能压缩**: 自适应压缩算法，节省60-80%空间
- ✅ **格式支持**: HEIF、WebP等现代图像格式
- ✅ **批量处理**: 并行图像处理能力
- ✅ **API优化**: 针对AI模型调用的图像优化

#### 系统架构
- ✅ **异步架构**: 全面采用asyncio异步编程
- ✅ **模块化设计**: 清晰的分层和职责分离
- ✅ **配置管理**: 灵活的环境变量和配置系统
- ✅ **错误处理**: 完善的异常处理和恢复机制

### 技术创新点 💡

#### 统一图像描述机制
- **问题**: 每个智能体重复调用视觉模型，浪费资源
- **解决**: 一次描述，全员共享，用户可见
- **效果**: 减少API调用，提升响应速度，改善用户体验

#### 两阶段AI架构
- **创新**: 视觉理解与对话生成分离
- **优势**: 专业化分工，提高准确性
- **实现**: Google Gemini (视觉) + DeepSeek (对话)

#### 智能体记忆系统
- **特点**: 个人记忆 + 全局共享记忆
- **技术**: Redis统一存储，简化架构复杂度
- **功能**: 上下文感知检索，记忆关联分析，自动清理机制

### 项目里程碑 🎯

- 📅 **2025-05-21**: 项目启动，基础架构设计
- 📅 **2025-06-03**: 前端界面完成，API集成
- 📅 **2025-06-08**: 代码重构，性能优化
- 📅 **2025-06-09**: 两阶段AI架构，统一图像描述
- 📅 **2025-06-22**: Redis清理功能修复，环境变量解析优化

### 文档记录 📚

#### 核心文档
- **arc.md**: 项目架构文档 (本文件)
- **README.md**: 项目说明和使用指南

---

*最后更新: 2025-06-22*
*版本: v2.2*
*技术栈: Python 3.8+ | AsyncIO | Redis | OpenRouter | Google Gemini*
