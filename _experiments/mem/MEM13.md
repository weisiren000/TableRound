# MEM13.md - TableRound核心功能优化记忆

## 核心记忆点

### 问题修复记忆
1. **Google模型图像识别**: 修复gemini-2.5-flash-preview-05-20模型的视觉支持判断
2. **关键词提取优化**: 添加<key_words>格式支持，移除默认关键词填充
3. **智能体个性化**: 为每个角色添加独特的语言风格特点

### 技术修复记忆

#### Google模型修复
- **文件**: `src/models/google.py`
- **位置**: 第51-59行
- **修复**: 添加`"gemini" in model_name.lower()`判断
- **原理**: Gemini系列模型都支持视觉功能

#### 关键词提取修复
- **文件**: `src/core/agent.py`
- **修复1**: 添加`<key_words>`标签解析支持
- **修复2**: 移除默认关键词生成逻辑（第541-587行）
- **修复3**: 移除random导入依赖

#### 提示词优化
- **基础提示词**: `src/config/prompts/base_prompts.py`
- **关键词提示词**: `src/config/prompts/function_prompts/keyword_extraction_prompts.py`
- **角色提示词**: `src/config/prompts/agent_prompts/*.py`

### 代码变更记忆

#### Google模型视觉支持
```python
# 修复前
self.vision_supported = "vision" in model_name.lower() or model_name in [
    "gemini-2.5-flash-preview-04-17", "gemini-pro-vision"
]

# 修复后
self.vision_supported = (
    "vision" in model_name.lower() or 
    "gemini" in model_name.lower() or  # 新增
    model_name in [
        "gemini-2.5-flash-preview-04-17", 
        "gemini-2.5-flash-preview-05-20",  # 新增
        "gemini-pro-vision"
    ]
)
```

#### 关键词解析逻辑
```python
# 新增<key_words>标签支持
key_words_match = re.search(r'<key_words>(.*?)</key_words>', response, re.DOTALL)
if key_words_match:
    keywords_str = key_words_match.group(1)
    keywords = [k.strip().strip('"\'') for k in keywords_str.split(',')]
```

#### 个性化提示词
```python
# 系统提示词新增指导原则
重要指导原则：
1. 避免使用套话、客套话或重复的表达方式
2. 不要说"确实挺有意思的"、"让我想想...怎么说呢..."等雷同的口语
3. 直接表达你的观点，展现你的专业性和个性
4. 每次回答都要体现你独特的视角和经验
```

## 角色个性化记忆

### 手工艺人 (Craftsman)
- **年龄**: 60岁蒙古族传统剪纸承人
- **经验**: 50年剪纸技艺
- **语言风格**: 朴实直接，用工艺细节说明问题，分享传统经验
- **特点**: 用词简洁有力，不喜欢绕弯子

### 消费者 (Consumer)
- **身份**: 普通消费者，关注使用体验和价值
- **语言风格**: 随性生活化，用个人体验思考问题
- **特点**: 语言活泼，会用网络用语，直接表达喜好

### 制造商 (Manufacturer)
- **身份**: 35岁文创产品生产商，4年经验
- **语言风格**: 务实理性，用数据和成本分析问题
- **特点**: 语言简洁高效，注重逻辑性，主动提供解决方案

### 设计师 (Designer)
- **身份**: 23岁研究生设计师，4年产品设计经验
- **语言风格**: 充满创意想象力，用视觉化语言描述
- **特点**: 年轻化表达，用设计术语，感性注重体验

## 测试验证记忆

### 测试文件
- **位置**: `tests/features/test_simple_improvements.py`
- **功能**: 验证所有核心功能修复
- **结果**: 4/4项测试全部通过

### 测试覆盖
1. **Google模型视觉支持**: ✅ gemini-2.5-flash-preview-05-20正确识别
2. **关键词提取格式**: ✅ 支持4种不同格式解析
3. **提示词改进**: ✅ 系统和图片故事提示词包含个性化要求
4. **角色个性化**: ✅ 所有角色都包含语言风格特点

### 验证方法
```python
# Google模型测试
model.supports_vision()  # 返回True

# 关键词格式测试
formats = [
    "<key_words>词1, 词2, 词3</key_words>",
    '["词1", "词2", "词3"]',
    "词1\n词2\n词3"
]
# 所有格式都能正确解析

# 个性化测试
"语言风格特点" in role_description  # 所有角色都返回True
```

## 问题解决模式记忆

### 诊断流程
1. **现象收集**: 用户反馈图像不支持、关键词数量问题、发言雷同
2. **问题定位**: 逐层分析从用户界面到底层代码
3. **根因分析**: 找到具体的代码位置和逻辑问题
4. **解决方案**: 设计最小化、安全的修复方案
5. **验证测试**: 创建测试脚本验证修复效果

### 修复策略
- **最小化修改**: 只修改必要部分，保持系统稳定
- **向后兼容**: 新功能保持对旧格式的兼容
- **全面测试**: 修改后进行完整功能验证

## 工具使用记忆

### 代码分析工具
- **codebase-retrieval**: 查找相关代码和逻辑
- **view**: 查看具体文件内容
- **str-replace-editor**: 精确修改代码

### 测试工具
- **save-file**: 创建测试脚本
- **execute_command_desktop-commander**: 运行测试验证

### 文档工具
- **save-file**: 创建总结和记忆文档
- **str-replace-editor**: 更新项目文档

## 技术要点记忆

### 模型能力检测
- **原则**: 使用系列级别判断而非具体版本
- **方法**: 结合关键词、系列名称和白名单
- **扩展**: 新版本模型自动获得支持

### 数据解析设计
- **多格式支持**: JSON、标签、数组、行分割
- **解析优先级**: 从最结构化到最简单
- **容错处理**: 每种格式独立错误处理

### 个性化设计
- **层次结构**: 系统级别 -> 角色级别 -> 个体级别
- **差异化**: 每个角色独特的语言风格
- **一致性**: 角色特征与专业背景一致

## 常见问题记忆

### 编码问题
- **问题**: PowerShell中Unicode字符显示错误
- **解决**: 移除emoji字符，使用纯文本
- **预防**: 在Windows环境下避免特殊Unicode字符

### 方法名问题
- **问题**: 方法名不匹配（supports_image_processing vs supports_vision）
- **解决**: 查看实际代码确认正确方法名
- **预防**: 使用IDE或代码分析工具确认接口

### 依赖问题
- **问题**: 测试脚本导入复杂依赖失败
- **解决**: 创建简化版本避免依赖
- **预防**: 测试脚本尽量独立，减少外部依赖

## 项目影响记忆

### 用户体验提升
- **图像功能**: Google模型图像分析功能恢复
- **关键词精准**: 不再有无意义的默认关键词
- **对话多样**: 智能体回复更加个性化

### 系统稳定性
- **格式兼容**: 支持多种关键词格式
- **错误处理**: 改进关键词提取错误处理
- **日志记录**: 增加详细的提取日志

### 代码质量
- **逻辑优化**: 移除不必要的默认值生成
- **可维护性**: 提示词模块化设计
- **测试覆盖**: 增加功能验证测试

## 最佳实践记忆

### 问题修复原则
1. **现象到本质**: 从用户反馈深入到代码实现
2. **系统性思考**: 考虑问题的全局影响
3. **数据驱动**: 用测试数据验证解决方案
4. **持续监控**: 修复后持续观察效果

### 代码修改原则
1. **最小化影响**: 只修改必要的部分
2. **保持兼容**: 不破坏现有功能
3. **充分测试**: 每次修改都要验证
4. **文档同步**: 及时更新相关文档

### 个性化设计原则
1. **差异化**: 每个角色都要有独特特征
2. **一致性**: 角色特征要与背景一致
3. **自然性**: 语言风格要自然不刻意
4. **可扩展**: 便于后续添加新角色

## 未来应用记忆

### 功能扩展方向
- **更多模型**: 为其他AI模型添加图像支持
- **关键词质量**: 增加关键词质量评估
- **个性化深化**: 进一步丰富角色特征

### 监控优化
- **使用统计**: 监控各功能使用情况
- **错误追踪**: 建立错误报告机制
- **性能监控**: 监控响应时间和资源使用

### 复用价值
- **模型检测模式**: 可用于其他模型集成
- **数据解析框架**: 可用于其他数据处理
- **个性化系统**: 可用于其他AI角色设计

## 总结记忆
这次TableRound核心功能优化成功解决了三个关键问题：Google模型图像识别支持、关键词提取逻辑优化、智能体个性化差异。通过系统性的问题分析、精准的代码修复和全面的功能验证，显著提升了系统的可用性和用户体验。关键在于建立了可复用的问题解决模式和技术实现方案，为后续的系统优化提供了宝贵的经验和工具。
